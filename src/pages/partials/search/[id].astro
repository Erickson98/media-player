---
import AlbumCarrousel from "src/components/AlbumCarrousel.astro";
import ArtistCarrousel from "src/components/ArtistCarrousel.astro";
import TopTracks from "src/components/Search/TopTracks.astro";
import Footer from "src/components/Footer.astro";
const { id } = Astro.params;

const searchQuery = new URL(
  `/api/spotify/search?q=${id}&type=album%2Cartist%2Ctrack&limit=10`,
  Astro.url
);

const headers = new Headers({ Accept: "application/json" });
const cookie = Astro.request.headers.get("cookie");
if (cookie) headers.set("cookie", cookie);

const res = await fetch(searchQuery, { headers });
if (!res.ok) {
  throw new Error(`No se pudo cargar el álbum ${id} (status ${res.status})`);
}

const resQuery = await res.json();
const hasTracks = resQuery?.tracks?.items?.length > 0;
---

{
  hasTracks ? (
    <TopTracks tracks={resQuery.tracks} />
    <ArtistCarrousel artists={resQuery.artists} title="Artist"/>
    <AlbumCarrousel album={resQuery.albums} title="Album"/>
    <Footer/>
  ) : (
    <div class="empty-state">
      <h2>No se encontraron resultados</h2>
      <p>Intenta con otro artista, canción o álbum.</p>
    </div>
  )
}
