---
export const prerender = false;
---

<div id="right-panel">
  <p>Sin canción en reproducción</p>
</div>
<style>
  .img-album-cover {
    max-width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
  }
  .album-cover-wrapper {
    /* height: 100vh; */
  }
</style>
<!-- Plantilla HTML -->
<template id="right-panel-tpl">
  <div class="container-right-panel" style="margin: 20px;">
    <div>
      <div class="container-meta-description-song-right-panel">
        <span data-field="album-name-top"></span>
      </div>
    </div>
    <div>
      <img
        data-field="album-cover"
        width="500"
        class="img-album-cover"
        alt=""
        fetchpriority="high"
        decoding="sync"
        loading="eager"
      />
    </div>
    <div>
      <h2 data-field="album-name"></h2>
      <div class="container-meta-description-song-right-panel">
        <span data-list="artists"></span>
      </div>
    </div>
    <div class="album-cover-wrapper">
      <div class="album-cover-rigth-panel" data-field="hero-bg">
        <h2 style="font-weight: 700;font-size: large;padding: 9px;">
          About the artist
        </h2>
      </div>
      <p data-field="main-artist"></p>
      <span
        style="
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        margin-bottom: 8px;
        overflow: hidden;
        overflow-wrap: anywhere;
        text-overflow: ellipsis;
      "
        data-field="artist-description"></span>
    </div>
  </div>
</template>

<script nonce={Astro.locals.nonce} type="module">
  const root5 = document.getElementById("right-panel");
  const tpl = document.getElementById("right-panel-tpl");

  function clearRight() {
    root5.innerHTML = `<p>Sin canción en reproducción</p>`;
  }
  import { OverlayScrollbars } from "https://cdn.jsdelivr.net/npm/overlayscrollbars/+esm";
  let osInstance = null;

  function initScroll() {
    const target = document.getElementById("right-panel");

    if (osInstance) {
      osInstance.destroy();
      osInstance = null;
    }

    osInstance = OverlayScrollbars(target, {
      scrollbars: { autoHide: "leave", theme: "os-theme-light" },
      overflow: { x: "hidden" },
    });
  }

  function renderRight({
    albumId,
    trackId,
    trackName,
    imgAlbum,
    artistImg,
    trackArtists,
    bioArtist,
    artistName,
    albumName,
  }) {
    root5.replaceChildren();
    console.log(trackName);
    console.log(artistName);
    const node = tpl.content.cloneNode(true);
    const q = (sel) => node.querySelector(sel);
    const imgUrl = imgAlbum ?? "";

    q('[data-field="album-name-top"]').textContent = albumName ?? "";
    q('[data-field="album-name"]').textContent = trackName ?? "";

    const imgEl = q('[data-field="album-cover"]');
    if (imgUrl) {
      imgEl.src = imgAlbum;
    }

    const artistsContainer = q('[data-list="artists"]');
    artistsContainer.replaceChildren(
      document.createTextNode(
        (trackArtists ?? []).map((a) => a.name).join(", ")
      )
    );
    const heroBg = q('[data-field="hero-bg"]');
    heroBg.style.backgroundPosition = "50% 50%";
    heroBg.style.backgroundSize = "cover";
    heroBg.style.aspectRatio = "3 / 2";
    heroBg.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 50%), url(${artistImg})`;

    q('[data-field="main-artist"]').textContent = trackArtists?.[0]?.name ?? "";
    q('[data-field="artist-description"]').textContent =
      bioArtist ?? "No description available.";

    root5.appendChild(node);
    initScroll();
  }

  // window.addEventListener("route:home", clearRight);
  // window.addEventListener("route:album", clearRight);

  // Escucha evento con álbum
  window.addEventListener("ui:track", (e) => {
    const {
      albumId,
      trackId,
      trackName,
      imgAlbum,
      artistImg,
      trackArtists,
      bioArtist,
      artistName,
      albumName,
    } = e.detail;
    renderRight({
      albumId,
      trackId,
      trackName,
      imgAlbum,
      artistImg,
      trackArtists,
      bioArtist,
      artistName,
      albumName,
    });
  });
</script>
