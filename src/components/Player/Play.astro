<link rel="stylesheet" href="/Play.css" />
<div class="container-play">
  <div class="top-play-component-actions">
    <button class="previous-action" aria-label="previous play">
      <img src="/previous.svg" width="15" alt="" srcset="" />
    </button>

    <button class="play-action" aria-label="play action">
      <img
        src="/iconPlay.svg"
        class="play-action-icon"
        data-action="pause"
        width="15"
        alt=""
        srcset=""
      />
    </button>

    <button class="next-action" aria-label="next play">
      <img src="/next.svg" width="15" alt="" srcset="" />
    </button>
  </div>
  <div class="container-for-play-component">
    <span id="time-current">0:00</span>
    <div class="progress-container progress-bar-track" id="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
      <div class="progress-knob" id="progress-knob"></div>
    </div>
    <span id="time-total">0:00</span>
  </div>
</div>

<script nonce={Astro.locals.nonce} type="module">
  let player;
  let duration = 0;
  let position = 0;
  let lastUpdate = 0;
  let isPlaying = false;

  const bar = document.getElementById("progress-bar");
  const knob = document.getElementById("progress-knob");
  const timeCurrent = document.getElementById("time-current");
  const timeTotal = document.getElementById("time-total");
  const container = document.getElementById("progress-container");

  function msToTime(ms) {
    const m = Math.floor(ms / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    return `${m}:${s.toString().padStart(2, "0")}`;
  }

  function updateUI() {
    const percent = position / duration;
    bar.style.transform = `scaleX(${percent})`;
    knob.style.transform = `translate(${percent * container.clientWidth}px, -50%)`;
    timeCurrent.textContent = msToTime(position);
    timeTotal.textContent = msToTime(duration);
  }

  function animate() {
    if (isPlaying) {
      const now = Date.now();
      position += now - lastUpdate;
      if (position > duration) position = duration;
      updateUI();
      lastUpdate = now;
    } else {
      lastUpdate = Date.now();
    }
    requestAnimationFrame(animate);
  }
  import { spotifyPlayerAction } from "/scripts/spotifyPlayerActions.js";
  import { localStorageGet } from "/scripts/localStorage.js";

  import { playerEvents } from "/scripts/playerEvents.js";

  const PlayIcon = "/iconPlay.svg";
  const previousElement = document.querySelector(".previous-action");
  previousElement?.addEventListener("click", async () => {
    try {
      await spotifyPlayerAction("previous", { deviceId: window.deviceId });
    } catch (error) {}
  });

  const playElement = document.querySelector(".play-action");

  playElement?.addEventListener("click", async () => {
    let played = false;
    const imgElement = document.querySelector(".play-action-icon");
    if (imgElement.dataset.action === "pause") {
      imgElement.src = "/iconPause.svg";
      imgElement.dataset.action = "play";
      const lastPlayed = localStorageGet("lastPlayedHistory");
      if (!played) {
        await spotifyPlayerAction("play", {
          uris: [`spotify:track:${lastPlayed.trackId}`],
          deviceId: window.deviceId,
        });
      }
      playerEvents.dispatchEvent(new Event("resume"));
    } else if (imgElement.dataset.action === "play") {
      imgElement.src = PlayIcon;
      imgElement.dataset.action = "pause";
      // await spotifyPlayerAction("pause", {
      //   deviceId: window.deviceId,
      // });
      playerEvents.dispatchEvent(new Event("pause"));
    }
  });
  playerEvents.addEventListener("state", (e) => {
    const state = e.detail;
    if (!state) return;
    duration = state.duration;
    position = state.position;
    isPlaying = !state.paused;
    lastUpdate = Date.now();
    updateUI();
  });
  animate();
  const nextElement = document.querySelector(".next-action");
  nextElement?.addEventListener("click", async () => {
    try {
      await spotifyPlayerAction("next", { deviceId: window.deviceId });
    } catch (error) {}
  });
</script>
